# Проектная работа: Архитектура ПО компании «Тёплый дом»

## Оглавление

1. [Описание проекта](#описание-проекта)
2. [Часть 1. Анализ и планирование](#часть-1-анализ-и-планирование)
3. [Часть 2. Проектирование микросервисной архитектуры](#часть-2-проектирование-микросервисной-архитектуры)
4. [Часть 3. Разработка ER-диаграммы](#часть-3-разработка-er-диаграммы)
5. [Заключение](#заключение)

---

## Описание проекта

«Тёплый дом» занимается созданием экосистемы умных домов. Цель проекта — переход от монолитного приложения к микросервисной архитектуре, обеспечивающей:
- Масштабируемость и гибкость.
- Поддержку новых функций и интеграцию с устройствами партнёров.

---

## Часть 1. Анализ и планирование

### Текущее состояние системы (As-Is)

1. **Функциональность:**
   - Управление отоплением (включение/выключение, установка температуры).
   - Мониторинг температуры с датчиков.

2. **Архитектура:**
   - Тип: Монолитное приложение.
   - Язык: Java.
   - База данных: PostgreSQL.
   - Ограничения: Требуется остановка приложения для обновления.

3. **Проблемы текущей архитектуры:**
   - Ограниченная масштабируемость.
   - Отсутствие гибкости (нет поддержки стандартных протоколов).
   - Пользователи не могут самостоятельно подключать устройства.

### Цель перехода на микросервисную архитектуру

- Устранить проблемы масштабируемости.
- Обеспечить гибкость и асинхронное взаимодействие (через Kafka).
- Поддерживать новые устройства и интеграции.

### Диаграмма контекста (Context Diagram)

Диаграмма ниже визуализирует текущее состояние системы:

![Диаграмма контекста](context-diagram.png)

Код диаграммы доступен в файле: `diagrams/context.puml`.

---

## Часть 2. Проектирование микросервисной архитектуры

### Уровень Containers

Диаграмма уровня Containers отображает взаимодействие между основными микросервисами, API Gateway, базами данных и шиной данных Kafka.

#### Основные сервисы:
1. **Device Management Service:** Управление устройствами и их состоянием.
2. **Temperature Monitoring Service:** Сбор и хранение данных телеметрии.
3. **User Management Service:** Регистрация и управление пользователями.
4. **Notification Service:** Отправка уведомлений пользователям.
5. **Scenario Management Service:** Управление пользовательскими сценариями автоматизации.

![Диаграмма Containers](container-diagram.png)

Код диаграммы доступен в файле: `diagrams/container.puml`.

### Уровень Components

Пример диаграммы компонентов для Device Management Service:

![Диаграмма Components](component-diagram.png)

Код диаграммы доступен в файле: `diagrams/component.puml`.

---

## Часть 3. Разработка ER-диаграммы

### Описание задачи

ER-диаграмма помогает описать структуру данных системы, включая ключевые сущности и их связи.

#### Основные шаги:
1. Определены сущности:
   - Пользователи, дома, устройства, типы устройств, телеметрия и сценарии.
2. Добавлены атрибуты сущностей, включая идентификаторы, описания и временные метки.
3. Установлены связи между сущностями:
   - Пользователи владеют домами.
   - Дома содержат устройства.
   - Устройства производят телеметрию и имеют тип.

![ER-диаграмма](er.png)

Код диаграммы доступен в файле: `diagrams/er.puml`.

---

## Часть 4: Создание и документирование API

Для обеспечения взаимодействия между микросервисами системы «Тёплый дом» были созданы и задокументированы API двух типов:
1.	REST API — используется для синхронного взаимодействия микросервисов, когда требуется немедленный ответ.
2.	AsyncAPI — используется для асинхронного взаимодействия, например, для передачи телеметрии и отправки команд устройствам через Kafka.

### REST API

REST API позволяет выполнять следующие операции:
- Добавление нового устройства. 
- Получение списка устройств. 
- Получение информации о конкретном устройстве. 
- Обновление состояния устройства. 
- Удаление устройства.

Документация REST API хранится в файле [rest-api.yaml](rest-api.yaml).

### AsyncAPI

AsyncAPI описывает взаимодействие с использованием асинхронных сообщений. Основные каналы:
- device-command — публикация команд для управления устройствами. 
- telemetry-data — получение телеметрии от устройств.

Документация AsyncAPI хранится в файле [async-api.yaml](async-api.yaml).

### Примеры

Пример REST-запроса для добавления устройства:
```bash
POST /devices
Content-Type: application/json
{
  "type": "thermostat",
  "house_id": 1,
  "serial_number": "SN12345",
  "status": "active"
}
```

Пример Kafka-сообщения для отправки команды устройству:
```json
{
  "device_id": 101,
  "command": "set_temperature",
  "parameters": {
    "temperature": 22
  }
}
```

Как использовать

- Для работы с REST API используйте файл rest-api.yaml для генерации клиентского кода или тестирования через Swagger UI. 
- Для работы с AsyncAPI используйте файл async-api.yaml для настройки Kafka и взаимодействия с брокером сообщений.

---

## Заключение

Разработанная микросервисная архитектура и структурированная модель данных позволяют:
- Решить текущие проблемы монолитного приложения.
- Обеспечить гибкость и масштабируемость.
- Интегрировать устройства партнёров и добавлять новые функции.

Диаграммы и документация помогают визуализировать переход системы «Тёплый дом» к микросервисной архитектуре.